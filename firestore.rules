rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- REGLA FUNDAMENTAL: Denegar todo acceso por defecto ---
    match /{document=**} {
      allow read, write: if false;
    }

    // --- FUNCIONES DE UTILIDAD Y AUTORIZACIÃ“N ---
    function isSignedIn() {
      return request.auth != null;
    }

    // Obtiene el documento del usuario que realiza la peticiÃ³n.
    function getRequestingUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.token.email.lower()));
    }

    // Verifica si el usuario autenticado tiene el rol de 'administrador'.
    function isRegisteredAdmin() {
      return isSignedIn() && getRequestingUserDoc().data.role == 'administrador';
    }

    // ðŸ”¥ **CORRECCIÃ“N DE ESQUEMA: Se elimina 'userId' ya que el ID del documento es el email** ðŸ”¥
    function isValidUserData(data) {
      // Verifica que solo los campos permitidos estÃ©n presentes.
      let allowedKeys = ['name', 'role', 'career', 'controlNumber', 'potroEmail', 'institutionalEmail', 'email', 'phone', 'allowExternalAuth', 'firebaseUid', 'createdAt', 'updatedAt', 'createdBy', 'updatedBy'];
      return data.keys().hasOnly(allowedKeys) &&
             // Valida el tipo y formato de cada campo.
             data.name is string && data.name.size() > 0 && data.name.size() < 100 &&
             data.role is string && data.role in ['administrador', 'docente', 'auxiliar'] &&
             data.career is string && data.career in ['software', 'manufactura', 'mecatronica', 'global'] &&
             (data.potroEmail == null || (data.potroEmail is string && data.potroEmail.matches('.+@potros\\.itson\\.edu\\.mx$'))) &&
             (data.phone == null || (data.phone is string && data.phone.size() < 20));
    }

    // --- REGLAS PARA LA COLECCIÃ“N DE USUARIOS (`users`) ---
    match /users/{userEmail} {
      
      // ðŸ”¥ **CORRECCIÃ“N DE REGLA DE LECTURA** ðŸ”¥
      // Permiso para leer un ÃšNICO documento (get).
      // Un usuario puede leer su propio perfil, y un admin puede leer cualquiera.
      allow get: if isSignedIn() && (request.auth.token.email.lower() == userEmail || isRegisteredAdmin());

      // Permiso para leer la COLECCIÃ“N COMPLETA (list).
      // Solo los administradores pueden obtener la lista de todos los usuarios.
      allow list: if isRegisteredAdmin();

      // --- REGLAS DE ESCRITURA (SIN CAMBIOS) ---
      allow create: if isRegisteredAdmin() && isValidUserData(request.resource.data);
      allow update: if (isRegisteredAdmin() && isValidUserData(request.resource.data)) ||
                       (
                         isSignedIn() &&
                         request.auth.token.email.lower() == userEmail &&
                         request.resource.data.role == resource.data.role && // El rol no puede cambiar
                         (
                           request.resource.data.firebaseUid == request.auth.uid &&
                           resource.data.firebaseUid == null // Solo se puede escribir el UID si no existe
                         )
                       );
      allow delete: if isRegisteredAdmin();
    }

    // --- REGLAS PARA LA COLECCIÃ“N DE ACTIVIDADES (`activities`) ---
    match /activities/{activityId} {
      // Un usuario puede leer una actividad si es admin o si estÃ¡ asignado a ella.
      allow read: if isSignedIn() &&
        (isRegisteredAdmin() || resource.data.responsibleEmail.lower() == request.auth.token.email.lower());
      // Solo administradores pueden crear, actualizar o eliminar actividades.
      allow create, update, delete: if isRegisteredAdmin();
    }
  }
}
