rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- REGLA FUNDAMENTAL: Denegar todo acceso por defecto ---
    match /{document=**} {
      allow read, write: if false;
    }

    // --- FUNCIONES DE UTILIDAD Y AUTORIZACIÃ“N ---
    function isSignedIn() {
      return request.auth != null;
    }

    // Obtiene el documento del usuario que realiza la peticiÃ³n.
    function getRequestingUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.token.email.lower()));
    }

    // Verifica si el usuario autenticado tiene el rol de 'administrador'.
    function isRegisteredAdmin() {
      return isSignedIn() && getRequestingUserDoc().data.role == 'administrador';
    }

    // --- ðŸ”¥ FUNCIÃ“N AÃ‘ADIDA ðŸ”¥ ---
    // Verifica si el usuario es administrador O auxiliar.
    function isAdminOrAuxiliar() {
      let userRole = getRequestingUserDoc().data.role;
      return isSignedIn() && (userRole == 'administrador' || userRole == 'auxiliar');
    }

    function isValidUserData(data) {
      let allowedKeys = ['name', 'role', 'career', 'controlNumber', 'potroEmail', 'institutionalEmail', 'email', 'phone', 'allowExternalAuth', 'firebaseUid', 'createdAt', 'updatedAt', 'createdBy', 'updatedBy'];
      return data.keys().hasOnly(allowedKeys) &&
             data.name is string && data.name.size() > 0 && data.name.size() < 100 &&
             data.role is string && data.role in ['administrador', 'docente', 'auxiliar'] &&
             data.career is string && data.career in ['software', 'manufactura', 'mecatronica', 'global'] &&
             (data.potroEmail == null || (data.potroEmail is string && data.potroEmail.matches('.+@potros\\.itson\\.edu\\.mx$'))) &&
             (data.phone == null || (data.phone is string && data.phone.size() < 20));
    }

    // --- REGLAS PARA LA COLECCIÃ“N DE USUARIOS (`users`) ---
    match /users/{userEmail} {
      allow get: if isSignedIn() && (request.auth.token.email.lower() == userEmail || isRegisteredAdmin());
      allow list: if isRegisteredAdmin();
      allow create: if isRegisteredAdmin() && isValidUserData(request.resource.data);
      allow update: if (isRegisteredAdmin() && isValidUserData(request.resource.data)) ||
                       (
                         isSignedIn() &&
                         request.auth.token.email.lower() == userEmail &&
                         request.resource.data.role == resource.data.role && // El rol no puede cambiar
                         (
                           request.resource.data.firebaseUid == request.auth.uid &&
                           resource.data.firebaseUid == null // Solo se puede escribir el UID si no existe
                         )
                       );
      allow delete: if isRegisteredAdmin();
    }

    // --- ðŸ”¥ SECCIÃ“N MODIFICADA: REGLAS PARA LA COLECCIÃ“N DE ACTIVIDADES (`activities`) ðŸ”¥ ---
    match /activities/{activityId} {
      // PERMISOS DE LECTURA:
      // Admin, Auxiliar, o el usuario asignado pueden leer.
      allow read: if isAdminOrAuxiliar() || 
                    (isSignedIn() && resource.data.assigneeEmail.lower() == request.auth.token.email.lower());
      
      // PERMISOS DE ESCRITURA:
      // Solo los administradores o auxiliares pueden crear, actualizar o eliminar.
      allow write: if isAdminOrAuxiliar();
    }
  }
}
